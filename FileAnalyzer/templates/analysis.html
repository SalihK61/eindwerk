{% extends "base.html" %}
{% block title %}Analysis - {{ filename }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 space-y-12">
  <!-- 1. Analyse CSV Document -->
  <section>
    <h2 class="text-2xl font-semibold mb-4">1. Analyse CSV Document</h2>
    <div class="overflow-x-auto bg-gray-100 shadow rounded-lg p-6">
      <h3 class="text-xl font-medium mb-2">Detected Data Types</h3>
      <table class="min-w-full divide-y divide-gray-200 text-black mb-6">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Column</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Data Type</th>
          </tr>
        </thead>
        <tbody class="bg-gray-100 divide-y divide-gray-200">
          {% for col, dtype in dtypes.items() %}
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">{{ col }}</td>
            <td class="px-6 py-4 whitespace-nowrap">{{ dtype }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <h3 class="text-xl font-medium mb-2">Basic Statistics</h3>
      <table class="min-w-full divide-y divide-gray-200 text-black mb-6">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3">Column</th>
            <th class="px-6 py-3">Mean</th>
            <th class="px-6 py-3">Median</th>
            <th class="px-6 py-3">Missing Values</th>
          </tr>
        </thead>
        <tbody class="bg-gray-100 divide-y divide-gray-200">
          {% for stat in basic_stats %}
          <tr>
            <td class="px-6 py-4">{{ stat.column }}</td>
            <td class="px-6 py-4">{{ stat.mean }}</td>
            <td class="px-6 py-4">{{ stat.median }}</td>
            <td class="px-6 py-4">{{ stat.missing }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <h3 class="text-xl font-medium mb-2">Correlation Matrix</h3>
      <div class="overflow-x-auto">{{ corr | safe }}</div>
    </div>
  </section>

  <!-- 2. Remove Duplicates -->
  <section>
    <h2 class="text-2xl font-semibold mb-4">2. Remove Duplicates</h2>
    <div class="bg-gray-100 shadow rounded-lg p-6 text-black">
      <p><strong>Total rows:</strong> {{ total_rows }}</p>
      <p><strong>Duplicate rows detected:</strong> {{ dup_count }}</p>
      <a href="{{ url_for('main.download_file', filename=cleaned_filename) }}"
         class="inline-block mt-2 px-4 py-2 bg-indigo-600 text-white rounded">Download Cleaned CSV</a>
    </div>
  </section>

  <!-- 3. Detect Missing Data -->
  <section>
    <h2 class="text-2xl font-semibold mb-4">3. Detect Missing Data</h2>
    <div class="bg-gray-100 shadow rounded-lg p-6 text-black">
      <h3 class="font-medium mb-2">Missing per Column</h3>
      <table class="min-w-full divide-y divide-gray-200 text-black mb-4">
        <thead class="bg-gray-50">
          <tr><th class="px-6 py-3">Column</th><th class="px-6 py-3">Missing Count</th></tr>
        </thead>
        <tbody class="bg-gray-100 divide-y divide-gray-200">
          {% for col, miss in missing_stats.items() %}
          <tr><td class="px-6 py-4">{{ col }}</td><td class="px-6 py-4">{{ miss }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
      <p><strong>Rows with any missing:</strong> {{ missing_rows_count }}</p>
      <a href="{{ url_for('main.download_file', filename=missing_filename) }}"
         class="inline-block mt-2 px-4 py-2 bg-indigo-600 text-white rounded">Download Rows with Missing</a>
    </div>
  </section>

  <!-- 4. Generate PDF Report -->
  <section>
    <h2 class="text-2xl font-semibold mb-4">4. Generate PDF Report</h2>
    <div class="bg-gray-100 shadow rounded-lg p-6 text-black">
      <a href="{{ url_for('main.generate_pdf', csv_id=csv_file.id) }}"
         class="inline-block px-6 py-3 bg-green-600 text-white rounded">Download PDF Report</a>
    </div>
  </section>
</div>
{% endblock %}


{% block scripts %}
<script>
  // Debug dumps
  console.log('categoricalData =', {{ cat_data|tojson }});
  console.log('timeData       =', {{ time_data|tojson }});
  console.log('pieData        =', {{ pie_data|tojson }});
  console.log('numericCols    =', {{ numeric_cols|tojson }});

  const categoricalData = {{ cat_data|tojson }};
  const timeData = {{ time_data|tojson }};
  const pieData = {{ pie_data|tojson }};
  const numericCols = {{ numeric_cols|tojson }};

  const barSelect = document.getElementById('bar-column');
  const lineSelect = document.getElementById('line-column');
  const pieSelect = document.getElementById('pie-column');
  const numSelect = document.getElementById('numeric-column');

  let barChart, lineChart, pieChart, numChart;

  const colors = [
    'rgba(75, 192, 192, 0.6)',
    'rgba(255, 99, 132, 0.6)',
    'rgba(54, 162, 235, 0.6)',
    'rgba(255, 206, 86, 0.6)',
    'rgba(153, 102, 255, 0.6)',
  ];
  const borderColors = colors.map(c => c.replace('0.6', '1'));

  function renderBarChart(column) {
    if (!column||!categoricalData[column]) return;
    const ctx = document.getElementById('barChart').getContext('2d');
    const data = categoricalData[column];
    const labels = Object.keys(data);
    const values = Object.values(data);
    if (barChart) barChart.destroy();
    barChart = new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:column,data:values,backgroundColor:colors,borderColor:borderColors,borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}},plugins:{legend:{display:true},title:{display:true,text:`Bar Chart of ${column}`}}}});
  }

  function renderLineChart(column) {
    if (!column||!timeData[column]) return;
    const ctx = document.getElementById('lineChart').getContext('2d');
    const {dates,values} = timeData[column];
    if(lineChart) lineChart.destroy();
    lineChart=new Chart(ctx,{type:'line',data:{labels:dates,datasets:[{label:column,data:values,borderColor:colors[2],backgroundColor:colors[2].replace('0.6','0.2'),fill:false,tension:0.1}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true},x:{title:{display:true,text:'Date'}}},plugins:{legend:{display:true},title:{display:true,text:`Time Series of ${column}`}}}});
  }

  function renderPieChart(column) {
    if (!column||!pieData[column]) return;
    const ctx = document.getElementById('pieChart').getContext('2d');
    const data=pieData[column];const labels=Object.keys(data);const values=Object.values(data);
    if(pieChart) pieChart.destroy();
    pieChart=new Chart(ctx,{type:'pie',data:{labels,datasets:[{data:values,backgroundColor:colors,borderColor:borderColors,borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right'},title:{display:true,text:`Proportions of ${column}`}}}});
  }

  function renderNumericChart(column) {
    if(!column)return;
    // Numeric histogram not implemented - consider Chart.js histogram plugin or server-side bins
  }

  if(barSelect.options.length>1){barSelect.value=barSelect.options[1].value;renderBarChart(barSelect.value);}
  if(lineSelect.options.length>1){lineSelect.value=lineSelect.options[1].value;renderLineChart(lineSelect.value);}
  if(pieSelect.options.length>1){pieSelect.value=pieSelect.options[1].value;renderPieChart(pieSelect.value);}
  if(numSelect.options.length>1){numSelect.value=numSelect.options[1].value;}

  barSelect.addEventListener('change',()=>renderBarChart(barSelect.value));
  lineSelect.addEventListener('change',()=>renderLineChart(lineSelect.value));
  pieSelect.addEventListener('change',()=>renderPieChart(pieSelect.value));
  numSelect.addEventListener('change',()=>renderNumericChart(numSelect.value));
</script>
{% endblock %}